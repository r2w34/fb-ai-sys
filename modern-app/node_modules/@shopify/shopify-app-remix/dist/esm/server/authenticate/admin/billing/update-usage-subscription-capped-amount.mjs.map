{"version":3,"file":"update-usage-subscription-capped-amount.mjs","sources":["../../../../../../../src/server/authenticate/admin/billing/update-usage-subscription-capped-amount.ts"],"sourcesContent":["import {\n  HttpResponseError,\n  Session,\n  UpdateCappedAmountConfirmation,\n} from '@shopify/shopify-api';\n\nimport type {BasicParams} from '../../../types';\nimport {redirectToAuthPage} from '../helpers';\nimport {invalidateAccessToken} from '../../helpers';\n\nimport {UpdateUsageCappedAmountOptions} from './types';\nimport {redirectOutOfApp} from './helpers';\n\nexport function updateUsageCappedAmountFactory(\n  params: BasicParams,\n  request: Request,\n  session: Session,\n) {\n  return async function updateUsageCappedAmount(\n    options: UpdateUsageCappedAmountOptions,\n  ): Promise<never> {\n    const {api, logger} = params;\n\n    logger.debug('Updating usage subscription capped amount', {\n      shop: session.shop,\n      ...options,\n    });\n\n    let result: UpdateCappedAmountConfirmation;\n    try {\n      result = await api.billing.updateUsageCappedAmount({\n        session,\n        subscriptionLineItemId: options.subscriptionLineItemId,\n        cappedAmount: options.cappedAmount,\n      });\n    } catch (error) {\n      if (error instanceof HttpResponseError && error.response.code === 401) {\n        logger.debug('API token was invalid, redirecting to OAuth', {\n          shop: session.shop,\n        });\n        await invalidateAccessToken(params, session);\n        throw await redirectToAuthPage(params, request, session.shop);\n      } else {\n        throw error;\n      }\n    }\n\n    throw redirectOutOfApp(\n      params,\n      request,\n      result.confirmationUrl,\n      session.shop,\n    );\n  };\n}\n"],"names":[],"mappings":";;;;;;;;SAagB,8BAA8B,CAC5C,MAAmB,EACnB,OAAgB,EAChB,OAAgB,EAAA;AAEhB,IAAA,OAAO,eAAe,uBAAuB,CAC3C,OAAuC,EAAA;AAEvC,QAAA,MAAM,EAAC,GAAG,EAAE,MAAM,EAAC,GAAG,MAAM;AAE5B,QAAA,MAAM,CAAC,KAAK,CAAC,2CAA2C,EAAE;YACxD,IAAI,EAAE,OAAO,CAAC,IAAI;AAClB,YAAA,GAAG,OAAO;AACX,SAAA,CAAC;AAEF,QAAA,IAAI,MAAsC;AAC1C,QAAA,IAAI;AACF,YAAA,MAAM,GAAG,MAAM,GAAG,CAAC,OAAO,CAAC,uBAAuB,CAAC;gBACjD,OAAO;gBACP,sBAAsB,EAAE,OAAO,CAAC,sBAAsB;gBACtD,YAAY,EAAE,OAAO,CAAC,YAAY;AACnC,aAAA,CAAC;QACJ;QAAE,OAAO,KAAK,EAAE;AACd,YAAA,IAAI,KAAK,YAAY,iBAAiB,IAAI,KAAK,CAAC,QAAQ,CAAC,IAAI,KAAK,GAAG,EAAE;AACrE,gBAAA,MAAM,CAAC,KAAK,CAAC,6CAA6C,EAAE;oBAC1D,IAAI,EAAE,OAAO,CAAC,IAAI;AACnB,iBAAA,CAAC;AACF,gBAAA,MAAM,qBAAqB,CAAC,MAAM,EAAE,OAAO,CAAC;gBAC5C,MAAM,MAAM,kBAAkB,CAAC,MAAM,EAAE,OAAO,EAAE,OAAO,CAAC,IAAI,CAAC;YAC/D;iBAAO;AACL,gBAAA,MAAM,KAAK;YACb;QACF;AAEA,QAAA,MAAM,gBAAgB,CACpB,MAAM,EACN,OAAO,EACP,MAAM,CAAC,eAAe,EACtB,OAAO,CAAC,IAAI,CACb;AACH,IAAA,CAAC;AACH;;;;"}